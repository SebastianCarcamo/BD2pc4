import pickle
import time
from rtree import index

QUERY = [
0.07830266654491425, 0.1763841062784195, 0.005969850346446037, -0.14915204048156738,
-0.23384657502174377, 0.07365267723798752, -0.054542284458875656, -0.049504462629556656,
0.19443818926811218, -0.03220222145318985, 0.15137979388237, 0.054248496890068054,
-0.22202394902706146, -0.06529134511947632, -0.07623487710952759, 0.13590791821479797,
-0.16142700612545013, -0.07477179914712906, -0.11789284646511078, -0.13575337827205658,
-0.03282871097326279, 0.02539323829114437, 0.04792838171124458, -0.02575916238129139,
-0.10714435577392578, -0.24233569204807281, -0.05205114930868149, -0.11522853374481201,
0.12060569226741791, -0.1894649714231491, 0.1408623605966568, -0.006895032711327076,
-0.10373704880475998, -0.014572689309716225, -0.0014158552512526512, 0.05290716141462326,
-0.15104705095291138, -0.02107441984117031, 0.22298702597618103, -0.04552691802382469,
-0.18038448691368103, 0.03416680544614792, 0.069294273853302, 0.27010831236839294,
0.16354486346244812, -0.05153961479663849, -0.004185238853096962, -0.0753273293375969,
0.17194397747516632, -0.22608162462711334, 0.11630629003047943, 0.15066386759281158,
0.17085060477256775, 0.0827300176024437, 0.154390349984169, -0.10791106522083282,
0.07739420235157013, 0.21666720509529114, -0.2321716994047165, 0.08308731764554977,
0.11158324033021927, -0.05710374936461449, -0.12479463219642639, -0.05648971349000931,
0.13809707760810852, 0.11044879257678986, -0.1288232058286667, -0.1866144984960556,
0.12571892142295837, -0.10777021944522858, -0.02379876933991909, 0.12473910301923752,
-0.06371910870075226, -0.143527552485466, -0.25344401597976685, 0.04664352536201477,
0.3283000588417053, 0.169073686003685, -0.16409426927566528, -0.04771310091018677,
-0.060628701001405716, -0.006675235461443663, -0.007138166110962629, -0.015260076150298119,
-0.17284344136714935, -0.11322914063930511, -0.04413652420043945, 0.01624567061662674,
0.05876482278108597, -0.08339380472898483, -0.018093489110469818, 0.18633699417114258,
0.09536807239055634, 0.014067676849663258, -0.05217593163251877, 0.045030903071165085,
-0.1337551325559616, 0.007088826037943363, -0.08616463840007782, 0.01262697298079729,
0.07103464752435684, -0.1948024481534958, 0.018679343163967133, 0.015008999966084957,
-0.19541063904762268, 0.24177062511444092, 0.07337405532598495, 0.004084045998752117,
-0.010767473839223385, 0.02859538421034813, -0.1270359307527542, 0.0163866113871336,
0.27446624636650085, -0.29883554577827454, 0.32785290479660034, 0.19904941320419312,
0.011510943993926048, 0.11578628420829773, 0.15664586424827576, 0.048108283430337906,
-0.0052569350227713585, -0.06379489600658417, -0.040783852338790894, -0.08069980144500732,
-0.006930358707904816, -0.12676610052585602, -0.013478794135153294, 0.06102971360087395]

def parse_row(d):
    l = d
    new_list = [x for pair in zip(l,l) for x in pair]
    return tuple(new_list)


def make_index(rows):
    p = index.Property()
    p.dimension = 128
    p.dat_extension = "data"
    p.idx_extension = "index"
    idx = index.Index('3d_index',properties=p, interleaved = False)
    c_id = 0
    for key in rows:
        idx.insert(c_id, rows[key], key)
        c_id+=1

    return idx


with open("result.pkl", "rb") as f:
    data = pickle.load(f)
    new_list = {}
    for d in data:
        new_list[d[0]] = parse_row(d[1])

    idx = make_index(new_list)
    list_attempts = [100, 200, 400, 800, 1600, 3200, 6400, 12800] 
    for a in list_attempts:
        start_time = time.time()
        res = list(idx.nearest(parse_row(QUERY), a))
        print("--- %s seconds ---" % (time.time() - start_time))
